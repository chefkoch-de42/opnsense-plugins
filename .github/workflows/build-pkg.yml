name: Build & Publish FreeBSD pkg repo

on:
  push:
    branches: [ "master" ]
    # Tag format:  os-<plugin>/<version>  e.g. os-wancarp/0.0.2
    tags:
      - "os-*/*"
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  # ───────────────────────────────────────────────────────────────────────────
  # JOB 1 – find every sub-directory that has a Makefile with PLUGIN_NAME set.
  #          On a tag push only the tagged plugin is built.
  # ───────────────────────────────────────────────────────────────────────────
  discover:
    name: Discover plugins
    runs-on: ubuntu-latest
    outputs:
      plugin_dirs: ${{ steps.scan.outputs.plugin_dirs }}
      is_release:  ${{ steps.scan.outputs.is_release }}
      release_tag: ${{ steps.scan.outputs.release_tag }}
      plugin_name: ${{ steps.scan.outputs.plugin_name }}
    steps:
      - uses: actions/checkout@v4

      - name: Scan for plugin Makefiles
        id: scan
        run: |
          REF="${{ github.ref }}"
          IS_RELEASE="false"
          RELEASE_TAG=""
          PLUGIN_NAME_OUT=""

          if [[ "${REF}" == refs/tags/os-*/* ]]; then
            IS_RELEASE="true"
            RELEASE_TAG="${REF#refs/tags/}"
            PLUGIN_NAME="${RELEASE_TAG%%/*}"
            DIR_NAME="${PLUGIN_NAME#os-}"

            PLUGIN_DIR=""
            while IFS= read -r makefile; do
              dir=$(dirname "$makefile")
              name=$(grep '^PLUGIN_NAME' "$makefile" 2>/dev/null | awk '{print $2}')
              if [ "${name}" = "${DIR_NAME}" ]; then
                PLUGIN_DIR="${dir#./}"
                break
              fi
            done < <(find . -mindepth 2 -maxdepth 3 -name Makefile | sort)

            if [ -z "${PLUGIN_DIR}" ]; then
              echo "ERROR: no plugin directory found for tag ${RELEASE_TAG}" >&2
              exit 1
            fi
            DIRS="${PLUGIN_DIR}"
            PLUGIN_NAME_OUT="os-${DIR_NAME}"
          else
            DIRS=""
            while IFS= read -r makefile; do
              dir=$(dirname "$makefile")
              if grep -q '^PLUGIN_NAME' "$makefile" 2>/dev/null; then
                DIRS="${DIRS:+${DIRS} }${dir#./}"
              fi
            done < <(find . -mindepth 2 -maxdepth 3 -name Makefile | sort)
          fi

          echo "plugin_dirs=${DIRS}"            >> "$GITHUB_OUTPUT"
          echo "is_release=${IS_RELEASE}"       >> "$GITHUB_OUTPUT"
          echo "release_tag=${RELEASE_TAG}"     >> "$GITHUB_OUTPUT"
          echo "plugin_name=${PLUGIN_NAME_OUT}" >> "$GITHUB_OUTPUT"
          echo "Plugins: ${DIRS}  is_release=${IS_RELEASE}  tag=${RELEASE_TAG}"

  # ───────────────────────────────────────────────────────────────────────────
  # JOB 2 – build all .pkg files AND run pkg repo – all in ONE FreeBSD VM
  # ───────────────────────────────────────────────────────────────────────────
  build-and-repo:
    name: Build packages + pkg repo
    needs: discover
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Checkout gh-pages (create if missing)
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          path: gh-pages
        continue-on-error: true

      - name: Initialise gh-pages dir if branch did not exist yet
        run: |
          if [ ! -d gh-pages/.git ]; then
            rm -rf gh-pages
            mkdir gh-pages
            cd gh-pages
            git init -b gh-pages
            git remote add origin \
              "https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git"
          fi
          mkdir -p gh-pages/packages
          touch gh-pages/.nojekyll
          # Remove stale pkg data from previous runs
          rm -f gh-pages/packages/*.pkg  gh-pages/packages/packagesite* \
                gh-pages/packages/data*  gh-pages/packages/meta* \
                gh-pages/packages/*.conf
          find gh-pages/packages -mindepth 1 -type d -exec rm -rf {} + 2>/dev/null || true

      - name: Build all packages + run pkg repo (single FreeBSD VM)
        uses: vmactions/freebsd-vm@v1
        with:
          release: "14.3"
          usesh: true
          prepare: |
            pkg install -y pkg
          run: |
            set -e

            PLUGIN_DIRS="${{ needs.discover.outputs.plugin_dirs }}"
            PKGS_OUT="${GITHUB_WORKSPACE}/gh-pages/packages"
            mkdir -p "${PKGS_OUT}"

            for PLUGIN_DIR in ${PLUGIN_DIRS}; do
              PKG_NAME=$(      grep '^PLUGIN_NAME'       "${PLUGIN_DIR}/Makefile" | awk '{print $2}')
              PKG_VERSION=$(   grep '^PLUGIN_VERSION'    "${PLUGIN_DIR}/Makefile" | awk '{print $2}')
              PKG_COMMENT=$(   grep '^PLUGIN_COMMENT'    "${PLUGIN_DIR}/Makefile" | cut -d= -f2- | sed 's/^[[:space:]]*//')
              PKG_MAINTAINER=$(grep '^PLUGIN_MAINTAINER' "${PLUGIN_DIR}/Makefile" | awk '{print $2}')
              PKG_WWW=$(       grep '^PLUGIN_WWW'        "${PLUGIN_DIR}/Makefile" | awk '{print $2}')
              PKG_CATEGORY=$(echo "${PLUGIN_DIR}" | cut -d/ -f1)
              # OPNsense ABI = OPNsense major.minor series (NOT FreeBSD version)
              # Must match the installed OPNsense series, e.g. 26.1
              PKG_ABI=$(grep '^PLUGIN_ABI' "${PLUGIN_DIR}/Makefile" | awk '{print $2}')
              PKG_ABI="${PKG_ABI:-26.1}"

              echo "==> Building os-${PKG_NAME}-${PKG_VERSION} from ${PLUGIN_DIR}"

              WORK="${GITHUB_WORKSPACE}/work/${PKG_NAME}"
              STAGE="${WORK}/stage"
              mkdir -p "${STAGE}/usr/local"

              # Stage source files
              (cd "${PLUGIN_DIR}/src" && find . -type f) | while read -r FILE; do
                SRC="${PLUGIN_DIR}/src/${FILE#./}"
                DST="${STAGE}/usr/local/${FILE#./}"
                mkdir -p "$(dirname "${DST}")"
                cp "${SRC}" "${DST}"
              done

              # Make syshook scripts executable
              find "${STAGE}/usr/local/etc/rc.syshook.d" -type f \
                -exec chmod +x {} \; 2>/dev/null || true

              # Replace placeholders in the opnsense/version file
              VERSION_FILE="${STAGE}/usr/local/opnsense/version/os-${PKG_NAME}"
              if [ -f "${VERSION_FILE}" ]; then
                sed -i '' \
                  -e "s|%%PLUGIN_ABI%%|${PKG_ABI}|g" \
                  -e "s|%%PLUGIN_NAME%%|${PKG_NAME}|g" \
                  -e "s|%%PLUGIN_VERSION%%|${PKG_VERSION}|g" \
                  -e "s|%%PLUGIN_MAINTAINER%%|${PKG_MAINTAINER:-${{ github.actor }}@users.noreply.github.com}|g" \
                  -e "s|%%PLUGIN_WWW%%|${PKG_WWW:-https://github.com/${{ github.repository }}}|g" \
                  "${VERSION_FILE}"
                echo "==> version file:"
                cat "${VERSION_FILE}"
              fi

              # plist
              PLIST="${WORK}/plist"
              (cd "${PLUGIN_DIR}/src" && find . -type f \
                | sed 's|^\./|/usr/local/|') > "${PLIST}"

              # +MANIFEST  (abi must match OPNsense: FreeBSD:14:amd64)
              # scripts block registers plugin with rc.configure_plugins (fixes 'misconfigured')
              POST_INSTALL="if [ -f /usr/local/etc/rc.d/configd ]; then /usr/local/etc/rc.d/configd restart; fi"
              POST_INSTALL="${POST_INSTALL}\nif [ -f /usr/local/opnsense/mvc/script/run_migrations.php ]; then /usr/local/opnsense/mvc/script/run_migrations.php OPNsense/WanCarp; fi"
              POST_INSTALL="${POST_INSTALL}\nif [ -f /usr/local/etc/rc.configure_plugins ]; then /usr/local/etc/rc.configure_plugins POST_INSTALL; fi"
              POST_DEINSTALL="if [ -f /usr/local/etc/rc.configure_plugins ]; then /usr/local/etc/rc.configure_plugins POST_DEINSTALL; fi"

              printf '%s\n' \
                "name: \"os-${PKG_NAME}\"" \
                "version: \"${PKG_VERSION}\"" \
                "origin: \"${PKG_CATEGORY}/os-${PKG_NAME}\"" \
                "comment: \"${PKG_COMMENT:-OPNsense plugin ${PKG_NAME}}\"" \
                "desc: \"${PKG_COMMENT:-OPNsense plugin ${PKG_NAME}}\"" \
                "maintainer: \"${{ github.actor }}@users.noreply.github.com\"" \
                "www: \"https://github.com/${{ github.repository }}\"" \
                "prefix: \"/usr/local\"" \
                "licenselogic: \"single\"" \
                "licenses: [ \"BSD2CLAUSE\" ]" \
                "abi: \"FreeBSD:14:amd64\"" \
                "arch: \"freebsd:14:x86:64\"" \
                "scripts: {" \
                "  post-install: \"${POST_INSTALL}\"," \
                "  post-deinstall: \"${POST_DEINSTALL}\"" \
                "}" \
                > "${WORK}/+MANIFEST"

              cp "${PLUGIN_DIR}/pkg-descr" "${WORK}/+DESC"

              pkg create \
                --root-dir "${STAGE}" \
                --manifest "${WORK}/+MANIFEST" \
                --plist    "${PLIST}" \
                --out-dir  "${PKGS_OUT}"
            done

            echo "==> All packages built:"
            ls -lh "${PKGS_OUT}"/*.pkg

            # Build the pkg repo index in the same VM – no second VM needed
            echo "==> Running pkg repo"
            pkg repo "${PKGS_OUT}"
            ls -lh "${PKGS_OUT}"

      - name: Generate repo .conf and landing page
        run: |
          REPO_URL="https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/packages"
          REPO_OWNER="${{ github.repository_owner }}"
          REPO_FULL="${{ github.repository }}"
          REPO_NAME="${{ github.event.repository.name }}"

          printf '%s\n' \
            "opnsense-plugins-${REPO_OWNER}: {" \
            "  url: \"${REPO_URL}\"," \
            "  signature_type: \"none\"," \
            "  priority: 10," \
            "  enabled: yes" \
            "}" \
            > gh-pages/packages/opnsense-plugins.conf

          PKG_ROWS=""
          for PKG in gh-pages/packages/os-*.pkg; do
            [ -f "$PKG" ] || continue
            NAME=$(basename "$PKG" .pkg | sed 's/-[0-9].*//')
            VER=$( basename "$PKG" .pkg | grep -oE '[0-9]+\.[0-9]+\.[0-9]+')
            PKG_ROWS+="<tr><td><b>${NAME}</b></td><td>${VER}</td>"
            PKG_ROWS+="<td><code>pkg install ${NAME}</code></td></tr>\n"
          done

          cat > gh-pages/index.html <<EOF
          <!DOCTYPE html>
          <html lang="en">
          <head>
            <meta charset="utf-8">
            <title>${REPO_NAME} - OPNsense Plugin Repository</title>
            <style>
              body  { font-family: monospace; max-width: 860px; margin: 2em auto; padding: 0 1em; }
              pre   { background: #f4f4f4; padding: .8em; border-radius: 4px; overflow-x: auto; }
              table { border-collapse: collapse; width: 100%; }
              th,td { border: 1px solid #ccc; padding: .4em .7em; text-align: left; }
              th    { background: #f0f0f0; }
            </style>
          </head>
          <body>
          <h1>${REPO_NAME} - OPNsense FreeBSD pkg Repository</h1>
          <p>Built automatically from <a href="https://github.com/${REPO_FULL}">GitHub</a>
             on every push to <code>master</code>.</p>
          <h2>Setup</h2>
          <pre>
          fetch -o /usr/local/etc/pkg/repos/${REPO_OWNER}-plugins.conf \\
            ${REPO_URL}/opnsense-plugins.conf

          pkg update &amp;&amp; pkg install os-wancarp
          </pre>
          <h2>Repository URL</h2>
          <pre>${REPO_URL}</pre>
          <h2>Available plugins</h2>
          <table>
            <tr><th>Package</th><th>Version</th><th>Install</th></tr>
            $(printf "%b" "${PKG_ROWS}")
          </table>
          <p style="margin-top:2em;font-size:.85em">
            <a href="https://github.com/${REPO_FULL}">Source on GitHub</a>
          </p>
          </body>
          </html>
          EOF

      - name: Commit & push gh-pages
        run: |
          cd gh-pages
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          git commit -m "chore: publish pkg repo [skip ci]" || echo "Nothing to commit"
          git push origin HEAD:gh-pages --force
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload package artifacts (for release job)
        uses: actions/upload-artifact@v4
        with:
          name: packages
          path: gh-pages/packages/os-*.pkg

  # ───────────────────────────────────────────────────────────────────────────
  # JOB 3 – create a GitHub Release with the .pkg as asset (tag pushes only)
  # ───────────────────────────────────────────────────────────────────────────
  release:
    name: Create GitHub Release
    needs: [ discover, build-and-repo ]
    if: needs.discover.outputs.is_release == 'true'
    runs-on: ubuntu-latest

    steps:
      - name: Download package artifacts
        uses: actions/download-artifact@v4
        with:
          name: packages
          path: release-assets

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.discover.outputs.release_tag }}
          name: ${{ needs.discover.outputs.release_tag }}
          body: |
            ## ${{ needs.discover.outputs.release_tag }}

            Install via pkg repo (recommended):
            ```sh
            fetch -o /usr/local/etc/pkg/repos/opnsense-plugins.conf \
              https://chefkoch-de42.github.io/opnsense-plugins/packages/opnsense-plugins.conf

            pkg update && pkg install ${{ needs.discover.outputs.plugin_name }}
            ```

            Or install the `.pkg` file directly (no repo needed):
            ```sh
            pkg add <direct-url-to-.pkg-file-from-assets-below>
            ```

            **pkg repo URL:** https://chefkoch-de42.github.io/opnsense-plugins/packages
          files: release-assets/*.pkg
          fail_on_unmatched_files: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
