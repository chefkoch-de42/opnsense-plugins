name: Build & Publish FreeBSD pkg repo

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  # ─────────────────────────────────────────────────────────────────────────────
  # JOB 1 – discover all plugins (every sub-directory that has a Makefile with
  #          PLUGIN_NAME set).  Produces a JSON matrix for the build job.
  # ─────────────────────────────────────────────────────────────────────────────
  discover:
    name: Discover plugins
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.scan.outputs.matrix }}
    steps:
      - uses: actions/checkout@v4

      - name: Scan for plugin Makefiles
        id: scan
        run: |
          plugins=()
          # Find every Makefile that declares PLUGIN_NAME (two levels deep: category/name)
          while IFS= read -r makefile; do
            dir=$(dirname "$makefile")
            if grep -q '^PLUGIN_NAME' "$makefile" 2>/dev/null; then
              plugins+=("$dir")
            fi
          done < <(find . -mindepth 2 -maxdepth 3 -name Makefile | sort)

          # Build a JSON array: [{"plugin_dir":"sysutils/os-wancarp"}, ...]
          json=$(printf '%s\n' "${plugins[@]}" | \
            sed 's|^\./||' | \
            python3 -c "
          import sys, json
          dirs = [l.strip() for l in sys.stdin if l.strip()]
          print(json.dumps({'include': [{'plugin_dir': d} for d in dirs]}))
          ")
          echo "matrix=${json}" >> "$GITHUB_OUTPUT"
          echo "Found plugins: ${plugins[*]}"

  # ─────────────────────────────────────────────────────────────────────────────
  # JOB 2 – build one .pkg per plugin (runs in parallel for each matrix entry)
  # ─────────────────────────────────────────────────────────────────────────────
  build:
    name: Build ${{ matrix.plugin_dir }}
    needs: discover
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.discover.outputs.matrix) }}

    steps:
      - uses: actions/checkout@v4

      - name: Build FreeBSD .pkg inside a FreeBSD VM
        uses: vmactions/freebsd-vm@v1
        with:
          usesh: true
          prepare: |
            pkg install -y pkg
          run: |
            set -e

            PLUGIN_DIR="${{ matrix.plugin_dir }}"

            # Derive values from Makefile
            PKG_NAME=$(grep    '^PLUGIN_NAME'    "${PLUGIN_DIR}/Makefile" | awk '{print $2}')
            PKG_VERSION=$(grep '^PLUGIN_VERSION' "${PLUGIN_DIR}/Makefile" | awk '{print $2}')
            PKG_COMMENT=$(grep '^PLUGIN_COMMENT' "${PLUGIN_DIR}/Makefile" | cut -d= -f2- | xargs)
            PKG_CATEGORY=$(echo "${PLUGIN_DIR}" | cut -d/ -f1)

            echo "Building ${PKG_NAME}-${PKG_VERSION} from ${PLUGIN_DIR}"

            WORK="${GITHUB_WORKSPACE}/work/${PKG_NAME}"
            STAGE="${WORK}/stage"
            PKGS="${WORK}/pkgs"
            mkdir -p "${STAGE}/usr/local" "${PKGS}"

            # ── Stage source files ───────────────────────────────────────────
            (cd "${PLUGIN_DIR}/src" && find . -type f) | while read -r FILE; do
              SRC="${PLUGIN_DIR}/src/${FILE#./}"
              DST="${STAGE}/usr/local/${FILE#./}"
              mkdir -p "$(dirname "${DST}")"
              cp "${SRC}" "${DST}"
            done

            # Make any carp / syshook scripts executable
            find "${STAGE}/usr/local/etc/rc.syshook.d" -type f \
              -exec chmod +x {} \; 2>/dev/null || true

            # ── plist ────────────────────────────────────────────────────────
            PLIST="${WORK}/plist"
            (cd "${PLUGIN_DIR}/src" && find . -type f | sed 's|^\./|/usr/local/|') \
              > "${PLIST}"

            # ── +MANIFEST ────────────────────────────────────────────────────
            cat > "${WORK}/+MANIFEST" <<MANIFEST
            name: "os-${PKG_NAME}"
            version: "${PKG_VERSION}"
            origin: "${PKG_CATEGORY}/os-${PKG_NAME}"
            comment: "${PKG_COMMENT:-OPNsense plugin ${PKG_NAME}}"
            maintainer: "${{ github.actor }}@users.noreply.github.com"
            www: "https://github.com/${{ github.repository }}"
            prefix: "/usr/local"
            licenselogic: "single"
            licenses: [ "BSD2CLAUSE" ]
            MANIFEST

            # ── +DESC ────────────────────────────────────────────────────────
            cp "${PLUGIN_DIR}/pkg-descr" "${WORK}/+DESC"

            # ── Create package ───────────────────────────────────────────────
            pkg create \
              --root-dir  "${STAGE}" \
              --manifest  "${WORK}/+MANIFEST" \
              --plist     "${PLIST}" \
              --out-dir   "${PKGS}"

            ls -lh "${PKGS}"

      - name: Upload package artifact
        uses: actions/upload-artifact@v4
        with:
          # Unique artifact name per plugin so parallel jobs don't collide
          name: pkg-${{ matrix.plugin_dir == '' && 'unknown' || matrix.plugin_dir }}
          path: work/*/pkgs/*.pkg

  # ─────────────────────────────────────────────────────────────────────────────
  # JOB 3 – collect all .pkg files, run `pkg repo`, publish to gh-pages
  # ─────────────────────────────────────────────────────────────────────────────
  publish:
    name: Publish pkg repo to GitHub Pages
    needs: build
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository (for metadata)
        uses: actions/checkout@v4
        with:
          path: source

      - name: Checkout gh-pages branch (create if missing)
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          path: gh-pages
        continue-on-error: true

      - name: Initialise gh-pages dir if branch did not exist
        run: |
          if [ ! -d gh-pages/.git ]; then
            rm -rf gh-pages
            mkdir gh-pages
            cd gh-pages
            git init -b gh-pages
            git remote add origin \
              "https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git"
          fi

      - name: Download all package artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: pkg-*
          merge-multiple: true
          path: gh-pages/packages

      - name: Run pkg repo inside a FreeBSD VM
        uses: vmactions/freebsd-vm@v1
        with:
          usesh: true
          prepare: |
            pkg install -y pkg
          run: |
            set -e
            cd "${GITHUB_WORKSPACE}/gh-pages/packages"
            pkg repo .
            ls -lh

      - name: Generate per-plugin repo.conf files and landing page
        run: |
          REPO_URL="https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/packages"
          REPO_OWNER="${{ github.repository_owner }}"
          REPO_NAME="${{ github.event.repository.name }}"
          GH_REPO="${{ github.repository }}"

          # One repo.conf that covers ALL packages in this repo
          cat > gh-pages/packages/opnsense-plugins.conf <<EOF
          opnsense-plugins-${REPO_OWNER}: {
            url: "${REPO_URL}",
            priority: 10,
            enabled: yes
          }
          EOF

          # Per-plugin .conf files (convenient single-plugin installs)
          for PKG in gh-pages/packages/*.pkg; do
            [ -f "$PKG" ] || continue
            # filename is os-<name>-<version>.pkg  →  strip prefix/suffix
            BASENAME=$(basename "$PKG" .pkg)
            # remove trailing -<version> part
            NAME=$(echo "$BASENAME" | sed 's/-[0-9].*//')
            cat > "gh-pages/packages/${NAME}.conf" <<EOF
          ${NAME}: {
            url: "${REPO_URL}",
            priority: 10,
            enabled: yes
          }
          EOF
          done

          # ── Build a simple HTML index ──────────────────────────────────────
          PKG_LIST_HTML=""
          for PKG in gh-pages/packages/*.pkg; do
            [ -f "$PKG" ] || continue
            BASENAME=$(basename "$PKG")
            NAME=$(echo "$BASENAME" | sed 's/-[0-9].*//')
            PKG_LIST_HTML+="<li><b>${NAME}</b> &nbsp; "
            PKG_LIST_HTML+="<code>pkg install ${NAME}</code> &nbsp; "
            PKG_LIST_HTML+="(<a href=\"packages/${NAME}.conf\">.conf</a>)</li>\n"
          done

          cat > gh-pages/index.html <<EOF
          <!DOCTYPE html>
          <html lang="en">
          <head>
            <meta charset="utf-8">
            <title>${REPO_NAME} – OPNsense Plugin Repository</title>
            <style>
              body { font-family: monospace; max-width: 820px; margin: 2em auto; padding: 0 1em; }
              pre  { background: #f4f4f4; padding: .8em; border-radius: 4px; overflow-x: auto; }
              code { background: #f4f4f4; padding: .1em .3em; border-radius: 3px; }
            </style>
          </head>
          <body>
          <h1>${REPO_NAME} – OPNsense FreeBSD pkg Repository</h1>
          <p>Hosted on GitHub Pages &bull; built automatically on every push to <code>main</code>.</p>

          <h2>Quick setup</h2>
          <pre>
          # 1. Add repository (covers all plugins in this repo)
          fetch -o /usr/local/etc/pkg/repos/${REPO_OWNER}-plugins.conf \\
            ${REPO_URL}/opnsense-plugins.conf

          # 2. Update &amp; install a plugin, e.g.:
          pkg update &amp;&amp; pkg install os-wancarp
          </pre>

          <h2>Repository URL</h2>
          <pre>${REPO_URL}</pre>

          <h2>Available plugins</h2>
          <ul>
          $(printf "%b" "${PKG_LIST_HTML}")
          </ul>

          <p><a href="https://github.com/${GH_REPO}">Source on GitHub</a></p>
          </body>
          </html>
          EOF

      - name: Commit & push gh-pages
        run: |
          cd gh-pages
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          git commit -m "chore: publish pkg repo [skip ci]" || echo "Nothing to commit"
          git push origin HEAD:gh-pages --force
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

