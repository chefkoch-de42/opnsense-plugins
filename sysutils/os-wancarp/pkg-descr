Automatically enables or disables a WAN interface based on CARP master/backup
state changes. Installs a CARP syshook script that reads its configuration
(interface key and trigger VHID) from the OPNsense GUI.

When this node becomes CARP MASTER the selected WAN interface is brought up
and re-configured (DHCP re-lease included). When the node drops to BACKUP the
interface is shut down so only the master node holds the upstream connection.

IMPORTANT â€“ Routing requirements
---------------------------------
Because only the MASTER firewall has an active WAN interface, the BACKUP
firewall must route all outbound traffic through the MASTER. This requires
the following static routes on BOTH firewalls:

IPv4
  Default route (0.0.0.0/0) via the LAN-side CARP VIP (e.g. 192.168.x.254).
  OPNsense: System > Routes > Configuration
  Gateway:  the shared LAN CARP VIP address of both firewalls

IPv6
  FreeBSD has a known issue where CARP failover does not automatically
  update IPv6 routing. Therefore the default IPv6 route must point to the
  link-local address of the respective peer interface on the LAN segment,
  NOT to a CARP VIP.

  On FW1: default IPv6 GW = link-local address of FW2 LAN interface
          (e.g. fe80::xxxx:xxxx:xxxx:xxxx%<LAN-if>)
  On FW2: default IPv6 GW = link-local address of FW1 LAN interface
          (e.g. fe80::xxxx:xxxx:xxxx:xxxx%<LAN-if>)

  OPNsense: System > Routes > Configuration
  Use the static gateway entries for each peer's link-local address.

  Background: with a shared CARP VIP as IPv6 gateway the BACKUP node would
  lose its default route during failover because the VIP moves to the MASTER
  and the local neighbour cache entry becomes stale. Using the peer's
  link-local address avoids this problem since it is always reachable on
  the LAN segment regardless of CARP state.

WWW: https://github.com/chefkoch-de42/opnsense-plugins

Plugin Changelog:
-----------------

0.0.9

* Fix interface dropdown: root cause was double-nested JSON response.
  internalModelName='general' + model root tag <general> caused the API
  to return {"general":{"general":{...}}} so setFormData could never
  match element ids. Fixed by changing internalModelName to 'wancarp'
  and updating all form field ids to wancarp.general.* accordingly.
  selectpicker() is now initialized inside mapDataToFormUI().done()
  after the options have been injected into the DOM.

0.0.8

* Fix interface dropdown (definitive): call selectpicker() init INSIDE
  mapDataToFormUI().done() so it runs after setFormData has injected
  the option elements into the <select>. The OPNsense layout does NOT
  auto-initialize selectpicker, so the init must happen after the
  options are present in the DOM.

0.0.8

* Fix interface dropdown: destroy and re-init selectpicker after
  mapDataToFormUI injects options so bootstrap-select renders correctly

0.0.7

* Fix interface dropdown not showing options: initialize selectpicker()
  before mapDataToFormUI() so setFormData() can correctly refresh the
  bootstrap-select widget after inserting the option elements

0.0.6

* Fix "(misconfigured)": post-install now directly writes os-wancarp into
  system.firmware.plugins in config.xml so OPNsense firmware page shows
  "installed" instead of "misconfigured"

0.0.5

* Fix "(misconfigured)" label: add post-install/post-deinstall pkg scripts
  to register plugin in system.firmware.plugins via rc.configure_plugins
* Add /usr/local/opnsense/version/os-wancarp with correct product_abi=26.1
* Add PLUGIN_ABI to Makefile (OPNsense series, not FreeBSD version)

0.0.4

* Fix "(misconfigured)" label: add /usr/local/opnsense/version/os-wancarp
  file required by opnsense-version -c check

0.0.4

* Fix "(misconfigured)" label in GUI: set model version to 0.0.0 to match
  the version already stored in config.xml (no migration needed)

0.0.3

* Fix interface dropdown: switch form type to dropdown, set InterfaceField
  Required=N and AllowDynamic=1 so all configured interfaces appear and
  the field can be saved without a "value required" validation error

0.0.2

* Fix PHP ParseError in GUI (apostrophe in Volt lang._() string)

0.0.1

* Initial release

